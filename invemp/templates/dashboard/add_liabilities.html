{% extends 'base.html' %}

{% block title %}Add Liabilities{% endblock %}

{% block content %}
<div class="liabilities-container">
  <h1>Add Liabilities to {{ entry[3] }}, {{ entry[2] }}</h1>
  <h2>Available Items</h2>
  <div class="filter-search">
    <form method="get" class="filter-form" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center; margin-bottom:1.2rem;">
      <input type="hidden" name="page" value="1">
      {% for col in columns %}
        <input type="text" name="filter_{{ col }}" value="{{ filters[col]|default('') }}" placeholder="Filter {{ col|replace('_',' ') }}" class="filter-input">
      {% endfor %}
      <button type="submit" class="filter-btn">Filter</button>
    </form>
  </div>
  {% if active_items and active_items|length > 0 %}
    <button type="button" id="clear-selections-btn" class="clear-btn-minimal" style="margin-bottom:1rem; margin-right:0.5rem;">Clear Selections</button>
    <form method="post">
      <table class="liabilities-table">
        <thead>
          <tr>
            <th></th>
            {% for column in columns %}
            <th>
              <a href="{{ url_for('dashboard_admin.add_liabilities', table_name=table_name, id=id, page=1, sort_column=column, sort_order='desc' if sort_column==column and sort_order=='asc' else 'asc', **filters) }}" class="sort-link" style="color:inherit; text-decoration:none;">
                {{ column }}
                {% if sort_column == column %}
                  <span style="font-size:1em;">{% if sort_order == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>
                {% endif %}
              </a>
            </th>
            {% endfor %}
            <th>View</th>
          </tr>
        </thead>
        <tbody>
          {% for item in active_items %}
          <tr>
            <td><input type="checkbox" name="selected_items" value="{{ item[0] }}"></td>
            {% for column in columns %}
            <td>{{ item[loop.index0] }}</td>
            {% endfor %}
            <td style="text-align:center;">
              <a href="{{ url_for('dashboard_user.view_details', table_name='items', id=item[0]) }}" class="view-details-btn" title="View Details">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="#2e2e52" style="vertical-align:middle;">
                  <circle cx="12" cy="12" r="10" stroke="#2e2e52" stroke-width="2" fill="#f3f4f6"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6 0c0 3.866-4.477 7-10 7S2 15.866 2 12 6.477 5 12 5s10 3.134 10 7z"/>
                </svg>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="assign-btn">Assign Selected Items</button>
    </form>
    <!-- Pagination Controls -->
    <div class="pagination" style="margin-top:1.5rem; text-align:center;">
      {% if total_pages > 1 %}
        <nav aria-label="Page navigation" class="page-navigation">
          <ul class="minimal-pagination">
            <li>
              <a href="{{ url_for('dashboard_admin.add_liabilities', table_name=table_name, id=id, page=page-1) }}" class="page-link prev {% if page <= 1 %}disabled{% endif %}" tabindex="{% if page <= 1 %}-1{% else %}0{% endif %}">&laquo; Prev</a>
            </li>
            {% for p in range(1, total_pages+1) %}
              <li>
                <a href="{{ url_for('dashboard_admin.add_liabilities', table_name=table_name, id=id, page=p) }}" class="page-link {% if p==page %}active{% endif %}">{{ p }}</a>
              </li>
            {% endfor %}
            <li>
              <a href="{{ url_for('dashboard_admin.add_liabilities', table_name=table_name, id=id, page=page+1) }}" class="page-link next {% if page >= total_pages %}disabled{% endif %}" tabindex="{% if page >= total_pages %}-1{% else %}0{% endif %}">Next &raquo;</a>
            </li>
          </ul>
        </nav>
      {% endif %}
    </div>
  {% else %}
    <p>No active items found.</p>
  {% endif %}
</div>
<script src="{{ url_for('static', filename='script/script.js') }}"></script>
<script>
// --- Persist checkbox selection across pagination using sessionStorage ---
const STORAGE_KEY = 'add_liabilities_selected_items';

function getSelectedItems() {
  try {
    return JSON.parse(sessionStorage.getItem(STORAGE_KEY)) || [];
  } catch (e) {
    return [];
  }
}
function setSelectedItems(arr) {
  sessionStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

// On page load, restore checked state
window.addEventListener('DOMContentLoaded', function() {
  const selected = getSelectedItems();
  document.querySelectorAll('input[type=checkbox][name=selected_items]').forEach(cb => {
    if (selected.includes(cb.value)) {
      cb.checked = true;
    }
    // Listen for changes
    cb.addEventListener('change', function() {
      let sel = getSelectedItems();
      if (cb.checked) {
        if (!sel.includes(cb.value)) sel.push(cb.value);
      } else {
        sel = sel.filter(v => v !== cb.value);
      }
      setSelectedItems(sel);
    });
  });

  // On form submit, add hidden inputs for all selected items
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Remove any previous hidden inputs
      form.querySelectorAll('input[type=hidden][name=selected_items]').forEach(el => el.remove());
      const sel = getSelectedItems();
      sel.forEach(val => {
        // Only add hidden input if not already checked on this page
        if (!form.querySelector('input[type=checkbox][name=selected_items][value="' + val + '"]:checked')) {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'selected_items';
          hidden.value = val;
          form.appendChild(hidden);
        }
      });
    });
  }

  // Clear selections button
  const clearBtn = document.getElementById('clear-selections-btn');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      setSelectedItems([]);
      document.querySelectorAll('input[type=checkbox][name=selected_items]').forEach(cb => {
        cb.checked = false;
      });
    });
  }
});
</script>
<style>
.liabilities-container {
  max-width: 600px;
  margin: 2rem auto;
  background: #fff;
  border-radius: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  padding: 2rem;
}
.liabilities-container h2 {
  font-size: 1.3rem;
  color: #2e2e52;
  margin-bottom: 1.2rem;
}
.liabilities-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
}
.liabilities-table th, .liabilities-table td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
  vertical-align: middle;
}
.liabilities-table td:last-child {
  text-align: center;
  vertical-align: middle;
}
.liabilities-table th {
  background: #f3f4f6;
  color: #22223b;
  font-weight: 600;
}
.liabilities-table tr:last-child td {
  border-bottom: none;
}
.assign-btn {
  margin-top: 1.2rem;
  background: #2e2e52;
  color: #fff;
  border: none;
  padding: 0.7rem 1.5rem;
  border-radius: 0.5rem;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s;
}
.assign-btn:hover {
  background: #43437a;
}
.assign-btn:active {
  background-color: #24244e;
  transform: scale(0.94);
}
.view-details-btn {
  background: linear-gradient(90deg, #f3f4f6 0%, #e0e7ff 100%);
  border: none;
  outline: none;
  cursor: pointer;
  display: inline-flex;
  align-content: center;
  justify-content: center;
  padding: 0.35rem 0.5rem;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(99,102,241,0.10);
  transition: background 0.18s, box-shadow 0.18s, transform 0.1s, color 0.18s;
  text-decoration: none;
  color: #2e2e52;
  position: relative;
  margin: auto 0;
}
.view-details-btn:hover, .view-details-btn:focus {
  background: linear-gradient(90deg, #60a5fa 0%, #6366f1 100%);
  box-shadow: 0 4px 16px rgba(99,102,241,0.18);
  transform: translateY(-1px) scale(1.10);
  color: #fff;
}
.view-details-btn svg {
  display: block;
  filter: drop-shadow(0 1px 2px rgba(99,102,241,0.10));
  transition: stroke 0.18s;
}
.view-details-btn:hover svg circle {
  stroke: #fff;
  fill: #6366f1;
}
.view-details-btn:hover svg path {
  stroke: #fff;
}
nav.page-navigation {
  background-color: #26264d;
  border-radius: 12px;
  padding: 0.5rem 1rem;
  box-shadow:
    rgba(0, 0, 0, 0.15) 0px 4px 12px,
    rgba(10, 37, 64, 0.2) 0px -2px 4px inset;
  display: flex;
  justify-content: center;
  align-items: center;
}

.minimal-pagination {
  display: inline-flex;
  gap: 0.4rem;
  list-style: none;
  padding: 0;
  margin: 0;
}

.minimal-pagination .page-link {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  min-width: 2.5rem;
  padding: 0.5rem 0.9rem;
  border-radius: 0.5rem;
  background: transparent;
  color: #f0f0f0;
  font-weight: 500;
  font-size: 1rem;
  border: 1px solid transparent;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.minimal-pagination .page-link:hover:not(.active):not(.disabled),
.minimal-pagination .page-link:focus-visible:not(.active):not(.disabled) {
  background-color: #4fc3a1;
  color: #000000;
  border-color: #4fc3a1;
  box-shadow: 0 0 0 2px rgba(79, 195, 161, 0.3);
}

.minimal-pagination .page-link.active {
  background-color: #308f6f;
  color: #ffffff;
  font-weight: 600;
  border-color: #308f6f;
}

.minimal-pagination .page-link.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}

.minimal-pagination .page-link.prev,
.minimal-pagination .page-link.next {
  color: #d1d1ff;
  font-weight: 600;
  border: 1px solid transparent;
}

.minimal-pagination .page-link.prev:hover,
.minimal-pagination .page-link.next:hover {
  color: #ffffff;
  background-color: #5e5eb7;
}

.clear-btn-minimal {
  background: #f3f4f6;
  color: #111;
  border: 1px solid #e5e7eb;
  padding: 0.3rem 0.9rem;
  border-radius: 0.4rem;
  font-size: 0.97rem;
  font-weight: 500;
  cursor: pointer;
  margin-bottom: 0.7rem;
  margin-right: 0.5rem;
  transition: background 0.15s, color 0.15s, border 0.15s, box-shadow 0.15s;
  box-shadow: none;
  outline: none;
  position: relative;
  overflow: hidden;
}
.clear-btn-minimal:hover {
  background: #dbeafe;
  color: #111;
  border-color: #60a5fa;
  box-shadow: 0 2px 8px rgba(96,165,250,0.10);
}
.clear-btn-minimal:active {
  background: #bae6fd;
  color: #111;
  border-color: #38bdf8;
}
.clear-btn-minimal::after {
  content: '';
  display: block;
  position: absolute;
  left: 50%;
  top: 50%;
  width: 0;
  height: 0;
  background: rgba(59,130,246,0.15);
  border-radius: 100%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  transition: width 0.25s cubic-bezier(.4,0,.2,1), height 0.25s cubic-bezier(.4,0,.2,1), opacity 0.25s;
  opacity: 0;
}
.clear-btn-minimal:active::after {
  width: 180%;
  height: 400%;
  opacity: 1;
  transition: 0s;
}
.filter-form {
  margin-bottom: 1.2rem;
}
.filter-input {
  padding: 0.35rem 0.7rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.4rem;
  font-size: 0.97rem;
  outline: none;
  transition: border 0.15s, box-shadow 0.15s;
  min-width: 120px;
}
.filter-input:focus {
  border-color: #6366f1;
  box-shadow: 0 2px 8px rgba(99,102,241,0.08);
}
.filter-btn {
  background: #6366f1;
  color: #fff;
  border: none;
  border-radius: 0.4rem;
  padding: 0.38rem 1.1rem;
  font-size: 0.97rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}
.filter-btn:hover, .filter-btn:focus {
  background: #43437a;
  color: #fff;
}
.sort-link {
  font-weight: 600;
  cursor: pointer;
  padding: 0.1em 0.2em;
  border-radius: 0.2em;
  transition: background 0.15s, color 0.15s;
}
.sort-link:hover, .sort-link:focus {
  background: #e0e7ff;
  color: #22223b;
  text-decoration: underline;
}
</style>
{% endblock %}
