{# 
Partial template for AJAX table and pagination updates only.
This template is rendered for both full page loads and AJAX requests.
#}
<table class="table table-striped sortable" id="main-table">
  <thead>
    <tr>
      {% for column in columns %}
        {% if column != 'password' and column not in ['category','serial_number','department','last_updated', 'description'] %}
          {# Only show arrow and toggle order for the sorted column #}
          <th style="cursor:pointer;"
              data-sort-column="{{ column }}"
              data-sort-order="{% if sort_column == column %}{{ 'desc' if sort_order == 'asc' else 'asc' }}{% else %}asc{% endif %}"
              {% if sort_column == column %}class="sorted"{% endif %}>
            {{ column.replace('_', ' ') }}
            {% if sort_column == column %}
              <span style="font-size:1em; vertical-align:middle;">
                {% if sort_order == 'asc' %}&#9650;{% else %}&#9660;{% endif %}
              </span>
            {% endif %}
          </th>
        {% endif %}
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for item in items if item[1] != g.user[1] %}
      {% if table_name == 'items_groups' %}
      <tr class="clickable-row" style="cursor:pointer;" onclick="window.location='{{ url_for('dashboard_user.index', table_name='items', brand_name=item[columns.index('brand_name')], subcategory=item[columns.index('subcategory_id')]) }}'">
      {% elif table_name == 'user_accounts' %}
      <tr class="clickable-row" style="cursor:pointer;" onclick="window.location='{{ url_for('dashboard_admin.update', table_name=table_name, id=item[0]) }}'">
      {% else %}
      <tr style="cursor: pointer;" onclick="window.location='{{ url_for('dashboard_user.view_details', table_name=table_name, id=item[0], page=page, sort_column=sort_column, sort_order=sort_order) }}'">
      {% endif %}
      {% for column, value in zip(columns, item) %}
        {% if column != 'password' %}
          {% if table_name == 'employees' and column == 'position' %}
          <td>
            <div>{{ value }}</div>
            <div style="font-size:0.85em; color:#242424; font-style:italic; margin-top:2px;">
              {{ item[columns.index('department')] }}
            </div>
          {% elif column in ['category','serial_number','department','last_updated','description'] %}
            {# skip category and department columns, already shown with item_name/Assigned To #}
          {% elif table_name == 'items' and column == 'subcategory' %}
          <td>
            <div>{{ value }}</div>
            <div style="font-size:0.85em; color:#242424; font-style:italic; margin-top:2px;">
              {{ item[columns.index('category')] }}
            </div>
          </td>
          {% elif table_name == 'items' and column == 'Assigned To' %}
          <td>
            <div>{{ value }}</div>
            <div style="font-size:0.85em; color:#242424; font-style:italic; margin-top:2px;">
              {{ item[columns.index('department')] }}
            </div>
            {% if table_name == 'items' %}
            <span class="action-btns">
              <a href="{{ url_for('dashboard_admin.history', table_name=table_name, id=item[0], **merged_args if merged_args is defined else request.args)}}" class="btn btn-table">
                <img src="{{ url_for('static', filename='icons/history.svg') }}" alt="History" class="icon">
              </a>
            </span>
            {% endif %}
          </td>
          {% elif table_name == 'employees' and column == 'user_account' %}
          <td>{{ item[-1] }}</td>
          {% else %}
          <td>{{ value }}</td>
          {% endif %}
        {% endif %}
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Remove any previous click handlers to avoid conflicts
  document.querySelectorAll('#main-table thead th[data-sort-column]').forEach(function(th) {
    th.onclick = null;
    th.addEventListener('click', function(e) {
      e.preventDefault();
      const col = th.getAttribute('data-sort-column');
      const order = th.getAttribute('data-sort-order');
      // Build new URL with sort params, reset to page 1
      const url = new URL(window.location.href);
      url.searchParams.set('sort_column', col);
      url.searchParams.set('sort_order', order);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    });
  });
});
</script>
<!-- Pagination controls -->
{% set max_display = 5 %}
{% set half_range = max_display // 2 %}
{% set start_page = page - half_range %}
{% if start_page < 1 %}
    {% set start_page = 1 %}
{% endif %}
{% set end_page = start_page + max_display - 1 %}
{% if end_page > total_pages %}
    {% set end_page = total_pages %}
    {% set start_page = end_page - max_display + 1 %}
    {% if start_page < 1 %}
        {% set start_page = 1 %}
    {% endif %}
{% endif %}

{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=page-1, **button_args if button_args is defined else pagination_args) }}">&laquo; Prev</a>
    {% endif %}

    {% if start_page > 1 %}
        <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=1, **button_args if button_args is defined else pagination_args) }}">1</a>
        {% if start_page > 2 %}
            <span>...</span>
        {% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% else %}
            <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=p, **button_args if button_args is defined else pagination_args) }}">{{ p }}</a>
        {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
            <span>...</span>
        {% endif %}
        <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=total_pages, **button_args if button_args is defined else pagination_args) }}">{{ total_pages }}</a>
    {% endif %}

    {% if page < total_pages %}
        <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=page+1, **button_args if button_args is defined else pagination_args) }}">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}
