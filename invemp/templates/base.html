<!doctype html>
<link rel="icon" href="{{ url_for('static', filename='icons/favicon/favicon.ico') }}">
<title>{% block title %}{% endblock %} - Inventory</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% if g.user %}
<nav>
  {% if not is_index %}
  <button class="btn-back" id="btn-back" type="button">
    <img src="{{ url_for('static', filename='icons/arrow_back.svg') }}" class="btn-back-icon">
    <img src="{{ url_for('static', filename='icons/arrow_back_2.svg') }}" class="btn-back-icon2">
  </button>
  {% endif %}
  {% if is_index %}
  <div id="download-btns">
    <a href="{{ url_for('dashboard_user.convert_pdf', table_name = table_name, **request.args) }}" id="btn-pdf" class="btn-download">
      <img src="{{ url_for('static', filename='icons/pdf_icon.svg') }}" alt="PDF" id="pdf-icon-img">
    </a>
    <a href="{{ url_for('dashboard_user.convert_pdf_qr', table_name = table_name, **request.args) }}" id="btn-qr" class="btn-download">
      <img src="{{ url_for('static', filename='icons/qr_code.svg') }}" alt="QR Code" id="qr-icon-img">
    </a>
  </div>
  {% endif %}
  {% if g.user[3] == 'admin'%}
  <ul class="tables-nav">
      {% if table_name == 'user_accounts' and g.user[3] == 'admin' and is_index %}
      <a href = "{{ url_for ('auth.register', **merged_args if merged_args is defined else pagination_args) }}" class="btn btn-create">Create User</a>
      {% elif g.user[3] == 'admin' and is_index and table_name not in ['items_disposal', 'employees_archive', 'items_groups'] %}
      <a href = "{{ url_for ('dashboard_admin.create', table_name = table_name, **merged_args if merged_args is defined else pagination_args) }}" class="btn btn-create">Create Entry</a>
      {% endif %}
    {% for table in tables if table not in ['item_assignment_history', 'items_categories', 'subcategories'] %}
    <li class="nav-item">
      {% if table == 'items' and table != table_name %}
      <div class="tables dropdown" id="table-link">
      <a href="{{ url_for('dashboard_user.index', table_name=table) }}" class="tables dropdown" id="table-link">
        <!-- Items table icon (SVG) -->
        <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
          <rect x="3" y="4" width="20" height="18" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
          <rect x="6" y="7" width="16" height="2" rx="1" fill="#fff"/>
          <rect x="6" y="11" width="14" height="2" rx="1" fill="#fff"/>
        </svg>
      </a>
        <span class="dropdown-arrow">&#9662;</span>
        <!-- Status Dropdown -->
        <div class="dropdown-content">
          {% for status in get_dropdown_options()['status'] %}
            <a href="{{ url_for('dashboard_user.index', 
            table_name='items', 
            **dict(request.args, status=status, page='')) }}">
            {{ status }}
          </a>
          {% endfor %}
        </div>
      </div>
      {% elif table == table_name and table == 'items' %}
        {% if request.args.get('status') == 'active' %}
        <h1 class="tables dropdown status-active" id="current-table">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <rect x="3" y="4" width="16" height="14" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
            <rect x="6" y="7" width="10" height="2" rx="1" fill="#fff"/>
            <rect x="6" y="11" width="7" height="2" rx="1" fill="#fff"/>
          </svg>
          <span class="dropdown-arrow">&#9662;</span>
          <!-- Status Dropdown -->
          <div class="dropdown-content">
            {% for status in get_dropdown_options()['status'] %}
              <a href="{{ url_for('dashboard_user.index', 
              table_name='items', 
              **dict(request.args, status=status, page='')) }}">{{ status }}</a>
            {% endfor %}
            {% if request.args.get(filters) %}
              <a href="{{ url_for('dashboard_user.index', table_name = table_name,
                       **dict(request.args, status='', page=''))}}"> All </a>
            {% endif %}
          </div>
        </h1>
        {% elif request.args.get('status') == 'assigned' %}
        <h1 class="tables dropdown status-assigned" id="current-table">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <rect x="3" y="4" width="16" height="14" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
            <rect x="6" y="7" width="10" height="2" rx="1" fill="#fff"/>
            <rect x="6" y="11" width="7" height="2" rx="1" fill="#fff"/>
          </svg>
          <span class="dropdown-arrow">&#9662;</span>
          <!-- Status Dropdown -->
          <div class="dropdown-content">
            {% for status in get_dropdown_options()['status'] %}
              <a href="{{ url_for('dashboard_user.index', 
              table_name='items', 
              **dict(request.args, status=status, page='')) }}">{{ status }}</a>
            {% endfor %}
            {% if request.args.get('status') %}
              <a href="{{ url_for('dashboard_user.index', table_name = table_name,
                      **dict(request.args, status='', page=''))}}"> All </a>
            {% endif %}
          </div>
        </h1>
        {% elif request.args.get('status') == 'for repair' %}
        <h1 class="tables dropdown status-repair" id="current-table">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <rect x="3" y="4" width="16" height="14" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
            <rect x="6" y="7" width="10" height="2" rx="1" fill="#fff"/>
            <rect x="6" y="11" width="7" height="2" rx="1" fill="#fff"/>
          </svg>
          <span class="dropdown-arrow">&#9662;</span>
          <!-- Status Dropdown -->
          <div class="dropdown-content">
            {% for status in get_dropdown_options()['status'] %}
              <a href="{{ url_for('dashboard_user.index', 
              table_name='items', 
              status=status) }}">{{ status }}</a>
            {% endfor %}
            {% if request.args.get('status') %}
              <a href="{{ url_for('dashboard_user.index', table_name = table_name,
                      **dict(request.args, status='', page=''))}}"> All </a>
            {% endif %}
          </div>
        </h1>
        {% elif request.args.get('status') == 'for disposal' %}
        <h1 class="tables dropdown status-disposal" id="current-table">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <rect x="3" y="4" width="16" height="14" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
            <rect x="6" y="7" width="10" height="2" rx="1" fill="#fff"/>
            <rect x="6" y="11" width="7" height="2" rx="1" fill="#fff"/>
          </svg>
          <span class="dropdown-arrow">&#9662;</span>
          <!-- Status Dropdown -->
          <div class="dropdown-content">
            {% for status in get_dropdown_options()['status'] %}
              <a href="{{ url_for('dashboard_user.index', 
              table_name='items', 
              **dict(request.args, status=status, page='')) }}">{{ status }}</a>
            {% endfor %}
            {% if request.args.get('status') %}
              <a href="{{ url_for('dashboard_user.index', table_name = table_name,
                      **dict(request.args, status='', page=''))}}"> All </a>
            {% endif %}
          </div>
        </h1>
        {% else %}
        <h1 class="tables dropdown" id="current-table">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <rect x="3" y="4" width="16" height="14" rx="2" fill="#f5bf6f" stroke="#333" stroke-width="1.2"/>
            <rect x="6" y="7" width="10" height="2" rx="1" fill="#fff"/>
            <rect x="6" y="11" width="7" height="2" rx="1" fill="#fff"/>
          </svg>
          <span class="dropdown-arrow">&#9662;</span>
          <!-- Status Dropdown -->
          <div class="dropdown-content">
            {% for status in get_dropdown_options()['status'] %}
              <a href="{{ url_for('dashboard_user.index', 
              table_name='items', 
              **dict(request.args, status=status, page='')) }}">{{ status }}</a>
            {% endfor %}
            {% if request.args.get('status') %}
              <a href="{{ url_for('dashboard_user.index', table_name = table_name,
                      **dict(request.args, status='', page=''))}}"> All </a>
            {% endif %}
          </div>
        </h1>
        {% endif %}
      {% elif table == 'user_accounts' and table != table_name %}
      <a href="{{ url_for('dashboard_user.index', table_name=table) }}" class="tables" id="table-link">
        <img src="{{ url_for('static', filename='icons/manage_accounts.svg') }}" class="nav-icon"> 
        user accounts
      </a>
      {% elif table == table_name and table == 'user_accounts' %}
      <h1 class="tables" id="current-table">
        <img src="{{ url_for('static', filename='icons/manage_accounts.svg') }}" class="nav-icon"> 
        user accounts
      </h1>
      {% elif table == table_name %}
      <h1 class="tables" id="current-table">
        {% if table == 'employees' %}
            <!-- Employees table icon (SVG) -->
            <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
              <circle cx="11" cy="5.5" r="6" fill="#7ec6e6" stroke="#333" stroke-width="1.5"/>
              <rect x="2" y="14" width="18" height="9" rx="2.5" fill="#fff" stroke="#333" stroke-width="1.2"/>
            </svg>
        {% elif table == 'items_groups' %}
            <!-- Items Groups table icon (SVG) -->
            <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
              <rect x="3" y="5" width="16" height="4" rx="2" fill="#b7e6a5" stroke="#333" stroke-width="1.2"/>
              <rect x="3" y="13" width="16" height="4" rx="2" fill="#b7e6a5" stroke="#333" stroke-width="1.2"/>
              <rect x="7" y="9" width="8" height="4" rx="2" fill="#fff" stroke="#333" stroke-width="1.2"/>
            </svg>
        {% endif %}
      </h1>
      {% else %}
      <a href="{{ url_for('dashboard_user.index', table_name=table) }}" class="tables" id="table-link">
        {% if table == 'employees' %}
            <!-- Employees table icon (SVG) -->
            <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
              <circle cx="11" cy="5.5" r="6" fill="#7ec6e6" stroke="#333" stroke-width="1.5"/>
              <rect x="2" y="14" width="18" height="9" rx="2.5" fill="#fff" stroke="#333" stroke-width="1.2"/>
            </svg>
          {% elif table == 'items_groups' %}
            <!-- Items Groups table icon (SVG) -->
            <svg class="nav-icon" width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
              <rect x="3" y="5" width="16" height="4" rx="2" fill="#b7e6a5" stroke="#333" stroke-width="1.2"/>
              <rect x="3" y="13" width="16" height="4" rx="2" fill="#b7e6a5" stroke="#333" stroke-width="1.2"/>
              <rect x="7" y="9" width="8" height="4" rx="2" fill="#fff" stroke="#333" stroke-width="1.2"/>
            </svg>
          {% endif %}
      </a>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if g.user %}
    {% if is_index %}
    <!-- Filter Form -->
    <form method="get" action="{{ url_for('dashboard_user.index', table_name=table_name) }}" id="filter-form" autocomplete="off">
      {% if request.args.get('status') %}
        <input type="hidden" name="status" value="{{ request.args.get('status') }}">
      {% endif %}
      <input type="text" name="search" value="{{ filters.get('search', '') }}" placeholder="Search..." id="filter-input">
      <a href="{{ url_for('dashboard_user.index', table_name=table_name, page=page, status=request.args.get('status')) }}" class="clear-btn" id="clear-filters-btn">Clear</a>
    </form>
  {% endif %}
  <section class="profile">
    <input type="checkbox" id="profile-toggle">
    <label for="profile-toggle" id="profile-icon">
      <img src="{{ url_for('static', filename='icons/profile_icon.svg') }}" 
      alt="profile" class="profile-icon-img">
    </label>
    <ul class="profile">
      <li id="current-user"><span>{{ g.user[1] }}</span>
      <li><a href="{{ url_for('auth.logout') }}" class="btn-53">
        <div class="original">Log Out</div>
        <div class="letters">
          <span>B</span>
          <span>Y</span>
          <span>E</span>
          <span>?</span>
        </div>
      </a>
    </ul>
  </section>
  {% endif %}
  {% if g.user[3] == 'admin' %}
  <!-- Settings Section -->
  <section class="settings">
    <input type="checkbox" id="settings-toggle">
    <label for="settings-toggle" id="settings-icon">
      <img src="{{ url_for('static', filename='icons/settings.svg') }}" 
      alt="settings" class="settings-icon-img">
    </label>
    <ul class="settings">
      {% for table in tables if table in ['items_categories'] %}
      <li>
        <a href="{{ url_for('dashboard_admin.settings_categories') }}" class="settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65
            1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65
            1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65
            1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65
            1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65
            1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65
            1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65
            1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65
            1.65 0 0 0-1.51 1z"></path>
          </svg>
          {{ table.replace('_', ' ').title() }}
        </a>
      </li>
      {% endfor %}
  </section>
  {% endif %}
  {#
  <button id="dark-mode-toggle" title="Toggle dark mode" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#f5bf6f;">
    <span id="dark-mode-icon" aria-label="Toggle dark mode" style="pointer-events:none;">🌙</span>
  </button>
  #}
</nav>
{% endif %}
<section class="content">
  <header>
    {% block header %}{% endblock %}
  </header>
  {% for message in get_flashed_messages() %}
  <div class="flash" data-flash>{{ message }}</div>
  {% endfor %}
  {% block content %}{% endblock %}
  <script src="{{ url_for('static', filename='script/script.js') }}"></script>
  <div id="global-loader" style="display:none;">
    <div class="loader-spinner">
      <img class="loader-logo" src="/static/images/MLQU-logo-1.png" alt="Loading...">
    </div>
  </div>
</section>
<script>
  // This script runs on every page load
  document.addEventListener('DOMContentLoaded', function () {
    const disallowedFragments = [
    '/create',
    '/update',
    '/add_liabilities',
    '/duplicate',
    '/delete'
  ];

  const currentPath = window.location.pathname + window.location.search;
  const currentBasePath = window.location.pathname;

  let historyStack = JSON.parse(sessionStorage.getItem('customBackStack') || '[]');

  const lastPath = historyStack[historyStack.length - 1] || '';
  const lastBasePath = lastPath.split('?')[0];

  const isDisallowed = disallowedFragments.some(fragment => currentPath.includes(fragment));
  const isDuplicate = currentPath === lastPath;
  const isSameBaseRepeated = currentBasePath === lastBasePath;

  // Prevent excessive pushing of the same page over and over
  if (!isDisallowed && !isDuplicate && !isSameBaseRepeated) {
    historyStack.push(currentPath);

    // Limit to 20 entries
    if (historyStack.length > 20) {
      historyStack.shift();
    }

    sessionStorage.setItem('customBackStack', JSON.stringify(historyStack));
  }
  });

  document.addEventListener('DOMContentLoaded', function () {
    const btnBack = document.getElementById('btn-back');

    if (btnBack) {
      btnBack.addEventListener('click', function (e) {
        e.preventDefault();

        let historyStack = JSON.parse(sessionStorage.getItem('customBackStack') || '[]');
        
        const disallowedFragments = [
          '/create',
          '/update',
          '/add_liabilities',
          '/duplicate',
          '/delete'
        ];

        historyStack.pop();

        while (historyStack.length > 0) {
          const candidate = historyStack.pop();
          const isDisallowed = disallowedFragments.some(fragment => candidate.includes(fragment));

          if (!isDisallowed) {
            sessionStorage.setItem('customBackStack', JSON.stringify(historyStack));
            window.location.href = candidate;
            return;
          }
        }

        // If no allowed page found, go to fallback
        window.location.href = "{{ url_for('dashboard_user.index', table_name=table_name, **request.args) }}";
      });
    }
  });
</script>